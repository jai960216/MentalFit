rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // === ì¸ì¦ í™•ì¸ ===
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'master';
    }
    
    // === ì‚¬ìš©ì ì •ë³´ ===
    match /users/{userId} {
      allow read: if isAuthenticated();
      // ğŸ”¥ ì¤‘ìš”: ìì‹ ì˜ ì •ë³´ ìˆ˜ì • + ê´€ë¦¬ìëŠ” ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ê°€ëŠ¥
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // === ìƒë‹´ì‚¬ ë“±ë¡ ìš”ì²­ ===
    match /counselorRequests/{requestId} {
      // ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ìš”ì²­ ìƒì„± ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì¼ë°˜ ì‚¬ìš©ì: ìì‹ ì˜ ìš”ì²­ë§Œ ì½ê¸° ê°€ëŠ¥
      // ê´€ë¦¬ì: ëª¨ë“  ìš”ì²­ ì½ê¸°/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow update, delete: if isAdmin();
    }
    
    // === ìƒë‹´ì‚¬ ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ===
    match /counselors/{counselorId} {
      // ğŸ”¥ ê´€ë¦¬ìë„ ìƒë‹´ì‚¬ ìƒì„± ê°€ëŠ¥ (ìŠ¹ì¸ ê³¼ì •ì—ì„œ í•„ìš”)
      allow create: if isAuthenticated() || isAdmin();
      
      // ìì‹ ì˜ ì •ë³´ë§Œ ìˆ˜ì • ê°€ëŠ¥, ê´€ë¦¬ìëŠ” ëª¨ë“  ì •ë³´ ìˆ˜ì • ê°€ëŠ¥
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      // ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥
      allow delete: if isAdmin();
      allow read: if isAuthenticated();
    }
    
    // === ì˜ˆì•½ ê´€ë ¨ ===
    match /appointments/{appointmentId} {
      allow read, write: if isAuthenticated();
    }
    
    // === ë¦¬ë·° ê´€ë ¨ ===
    match /reviews/{reviewId} {
      allow read, write: if isAuthenticated();
    }

    // === ì±„íŒ…ë°© ê´€ë ¨ ===
    match /chat_rooms/{roomId} {
      allow read, write: if isAuthenticated();

      // === ë©”ì‹œì§€ ===
      match /messages/{messageId} {
        allow read, write: if isAuthenticated();
      }
    }
  }
}